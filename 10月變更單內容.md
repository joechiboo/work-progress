# 2025年10月變更單內容

## 2025年10月 - 第1單

### 變更需求

**變更原因**：
1. 因應醫療資訊安全需求，原有 label-printing 系統採用 .NET Framework 3.5 版本過於老舊，存在以下問題：
   - 技術框架老舊，安全性更新不足
   - 存在 SQL Injection 安全漏洞風險
   - 效能不佳，無法滿足現代化需求

2. 業務需求改善：
   - OPD（門診）報告曾發生誤寄給之前送檢醫師的事故
   - 醫師抱怨收到非自己病患的檢驗報告
   - 需要建立 OPD 確認 email 機制，確保報告正確寄送

**變更內容**：
- 將 label-printing 專案從 .NET Framework 3.5 升級至 .NET 8
- 新增 SQL Injection 防護機制（UpdateCustomerDataSafe 方法）
- 實作 OPD email 確認機制
- 優化資料庫查詢效能
- 修正資料庫欄位名稱錯誤
- 加入版本資訊管理（2025.10.28 格式）

**申請人員**：

**單位主管（指派評估人員）**：

### 變更評估

**影響範圍評估**：

1. **系統架構變更**：
   - 框架升級：.NET Framework 3.5 → .NET 8
   - 目標平台：需重新編譯與測試
   - 相依套件：需更新至 .NET 8 相容版本

2. **資料庫影響**：
   - 新增 UpdateCustomerDataSafe 參數化查詢方法
   - 修正資料庫欄位名稱錯誤
   - 無資料表結構變更

3. **功能模組變更**：
   - 新增：OPD email 確認機制
   - 改善：SQL Injection 防護（參數化查詢）
   - 優化：查詢效能改善
   - 修正：版本號顯示格式

4. **測試範圍**：
   - 新增 UpdateCustomerDataSafe 單元測試
   - 全面回歸測試確保升級後功能正常

**技術評估**：

1. **執行規劃**：
   - 停機需求：是（需短暫停機約 10 分鐘進行部署）
   - 公告通知：是（需通知相關醫護人員）
   - 備份作業：是（部署前備份程式與資料庫）
   - 部署時機：建議選擇低峰時段（如晚上）

2. **風險評估**：
   - 變更風險：中（涉及框架升級，需充分測試）
   - 相容性風險：低（已完成單元測試與本地驗證）
   - 業務影響：中（影響醫師報告寄送流程）

3. **失敗處理**：
   - 若發生異常，立即回復至 .NET Framework 3.5 舊版本
   - 備有完整回退計畫與備份

**評估人員**：

**單位主管（指派執行人員）**：

**是否進行安全測試**：☑是 ☐否
（本次變更涉及 SQL Injection 防護，已進行安全性測試與驗證）

### 變更處理

**執行結果**：

本次變更於 2025 年 10 月 27-28 日執行完成，執行項目如下：

1. **框架升級**（2025-10-27）：
   - ✓ 完成 .NET 8 專案遷移（Initial commit: BasicBarcode .NET 8 migration project）
   - ✓ 更新所有相依套件至 .NET 8 相容版本

2. **安全性改善**（2025-10-27）：
   - ✓ 實作 SQL Injection 防護機制（Add .NET 8 migration with SQL Injection protection）
   - ✓ 新增 UpdateCustomerDataSafe 的單元測試並通過驗證

3. **功能完善**（2025-10-28）：
   - ✓ 修正資料庫欄位名稱錯誤
   - ✓ 修復單元測試並改進驗證邏輯
   - ✓ 加入版本資訊管理（2025.10.28 格式）
   - ✓ 修正版本號顯示格式
   - ✓ 更新 RUN.md：補充發佈指令說明

4. **部署與驗證**：
   - ✓ 已部署至正式環境
   - ✓ 系統運行正常，無異常錯誤
   - ✓ OPD email 確認機制運作正常

**執行狀態**：☑ 成功完成

**執行人員**：_________________ (日期: 2025/10/28)

---

## 2025年10月 - 第2單

### 變更需求

**變更原因**：
1. ReadOk 系統年久失修，原開發工程師已離職，維護性問題日益嚴重：
   - 缺乏完整文件，維護困難
   - 程式碼品質不佳，難以追蹤問題
   - 資料同步機制不穩定，常發生資料不一致

2. 效能與資料一致性問題：
   - 資料庫效能瓶頸，查詢速度緩慢
   - 網路報告查詢系統與紙本報告內容不一致
   - PAT_RESULTD 同步邏輯錯誤，保留了過期的 TRX_NUM

3. 桃園院區資料遷移需求：
   - 需完成全量資料遷移至新系統
   - 確保遷移過程資料完整性

**變更內容**：
- 修正 PAT_RESULTD 同步邏輯，只保留最新 TRX_NUM
- 新增 PAT_RESULTD 的 reported_dt 欄位支援
- 新增同步診斷工具和輔助腳本
- 新增 Oracle 重置腳本，用於重新同步被誤刪的單號
- 新增清理重複 pat_resulth 記錄的 SQL 文件
- 修正 MSSQL 表的欄位名稱錯誤
- 完成桃園院區全量資料遷移
- 優化日誌輸出，只顯示重要訊息
- 繞過 pat_resulthx 的有問題觸發器，直接寫入 pat_resulth
- 修正 pat_resulth 複合主鍵為 (order_no, test_code)
- 整理文件目錄結構，建立完整維護文檔

**申請人員**：

**單位主管（指派評估人員）**：

### 變更評估

**影響範圍評估**：

1. **系統架構變更**：
   - FalconCopy 資料同步機制重構
   - 同步邏輯優化與錯誤處理強化
   - 新增診斷與維護工具

2. **資料庫影響**：
   - PAT_RESULTD 表：新增 reported_dt 欄位，修正同步邏輯
   - PAT_RESULTH 表：修正複合主鍵定義
   - PAT_RESULTHX 觸發器：繞過有問題的觸發器
   - 清理重複資料：影響資料一致性
   - 桃園院區：全量資料遷移

3. **功能模組變更**：
   - 改善：資料同步穩定性與準確性
   - 新增：同步診斷工具
   - 新增：Oracle 重置腳本
   - 新增：髒資料檢查方法
   - 優化：日誌輸出機制
   - 優化：查詢效能

4. **測試範圍**：
   - 資料同步完整性測試
   - 重複資料清理驗證
   - 桃園院區資料遷移驗證
   - 診斷工具功能測試

**技術評估**：

1. **執行規劃**：
   - 停機需求：部分功能需停機（資料遷移時）
   - 公告通知：是（需通知相關使用者資料遷移時程）
   - 會同廠商：否（內部系統）
   - 備份作業：是（執行前完整備份 Oracle 與 MSSQL 資料庫）
   - 部署時機：分階段進行，重大變更選擇低峰時段

2. **風險評估**：
   - 變更風險：中高（涉及資料同步邏輯與資料遷移）
   - 資料風險：中（需確保資料完整性，已有回退機制）
   - 業務影響：高（影響網路報告查詢系統）

3. **失敗處理**：
   - 資料庫備份：所有變更前完整備份
   - 回退腳本：準備 Oracle 重置腳本
   - 段落式部署：優先部署診斷工具，確認無誤後再執行資料清理
   - 若發生異常，立即停止並使用備份還原

**評估人員**：

**單位主管（指派執行人員）**：

**是否進行安全測試**：☐是 ☑否
（本次變更主要為效能優化與資料一致性改善）

### 變更處理

**執行結果**：

本次變更於 2025 年 10 月 1-27 日分階段執行完成，執行項目如下：

1. **資料同步機制改善**（2025-10-01 至 2025-10-27）：
   - ✓ 修正 PAT_RESULTD 同步邏輯 - 只保留最新 TRX_NUM
   - ✓ 新增 PAT_RESULTD 的 reported_dt 欄位支援
   - ✓ 新增同步診斷工具和輔助腳本
   - ✓ 新增同步診斷工具和重置腳本
   - ✓ 新增髒資料檢查方法到手動重新同步指南

2. **資料庫優化與修正**（2025-10-07 至 2025-10-08）：
   - ✓ 新增 Oracle 重置腳本，用於重新同步被誤刪的單號
   - ✓ 新增清理重複 pat_resulth 記錄的 SQL 文件
   - ✓ 修正 MSSQL 表的欄位名稱錯誤
   - ✓ 繞過 pat_resulthx 的有問題觸發器，直接寫入 pat_resulth
   - ✓ 修正 pat_resulth 複合主鍵為 (order_no, test_code)

3. **桃園院區資料遷移**（2025-10-07）：
   - ✓ 完成全量資料遷移
   - ✓ 更新桃園遷徙專案文檔和 SQL 腳本
   - ✓ 驗證資料完整性與一致性

4. **維護性改善**（2025-10-01 至 2025-10-20）：
   - ✓ 精簡日誌輸出並修正欄位長度限制
   - ✓ 移除正常執行時的 SQL 日誌，只在錯誤時顯示
   - ✓ 簡化日誌輸出，只顯示重要訊息
   - ✓ 加強刪除操作的日誌追蹤
   - ✓ 整理文件目錄結構
   - ✓ 清理根目錄的重複文件
   - ✓ 新增 .gitignore 並移除已追蹤的 bin/obj 檔案
   - ✓ 將 DR_CODE 長度警告降為 DEBUG 級別並更新診斷文件

5. **部署與驗證**：
   - ✓ 所有變更已部署至正式環境
   - ✓ 資料同步穩定性顯著提升
   - ✓ 網路報告查詢系統與紙本報告一致性改善
   - ✓ 系統運行正常，無重大異常

**執行狀態**：☑ 成功完成

**執行人員**：_________________ (日期: 2025/10/27)
